#!/usr/bin/env ruby

require 'json'
require 'tmpdir'
require 'fileutils'

FILE_PATH = File.expand_path(ARGV[0])
LIB_NAME = ARGV[1]
RNBO_SRC_DIR = File.expand_path(ARGV[2])
OUTPUT_DIR = File.expand_path(ARGV[3])

#validate
raise "#{RNBO_SRC_DIR} is not a valid directory" unless Dir.exist?(RNBO_SRC_DIR)
raise "#{OUTPUT_DIR} is not a valid directory" unless Dir.exist?(OUTPUT_DIR)

so_build_dir = File.join(File.expand_path(__dir__), "../share/rnbo/so/")
raise "cannot find CMakeLists.txt in #{so_build_dir}" unless File.exist?(File.join(so_build_dir, "CMakeLists.txt"))

#compile in a temp directory, then move the shared object to the OUTPUT_DIR
Dir.mktmpdir do |dir|
  Dir.chdir(dir) do
    cmd = "cmake -DRNBO_CLASS_FILE=#{FILE_PATH} -DRNBO_DIR=#{RNBO_SRC_DIR} -DLIBRARY_NAME_PREFIX=#{LIB_NAME} #{so_build_dir}"
    raise "#{cmd} failed" unless system(cmd)
    raise "make failed" unless system("make")
    FileUtils.mv(Dir['*.{so,dll,dylib}'], OUTPUT_DIR)
  end
end
